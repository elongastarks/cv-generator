<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cr√©ation CV Pro - Pr√©visualisation</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
    body { background:#f5f5f5; padding:20px; }
    h2,h3 { color:#333; }
    h2 { text-align:center; margin-bottom:20px; }

    /* Container principal */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    /* Formulaire */
    .form-section {
      flex: 1 1 400px;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .form-section h3 { margin-bottom:10px; }
    input, textarea, select {
      width:100%;
      padding:10px 12px;
      margin:8px 0;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:14px;
    }
    textarea { resize: vertical; min-height:60px; }
    button {
      background: linear-gradient(90deg, #1e3c72, #2a5298);
      color:#fff;
      padding:10px 18px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      margin-top:10px;
      transition: all 0.2s;
    }
    button:hover { transform: scale(1.03); }

    /* Sections dynamiques (exp√©riences/formations) */
    .sub { margin-bottom:12px; padding:10px; border:1px solid #e0e0e0; border-radius:8px; background:#f9f9f9; }

    /* Pr√©visualisation */
    .preview-section {
      flex: 1 1 500px;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      max-height: 90vh;
      overflow-y: auto;
    }
    .preview-section h3 { text-align:center; margin-bottom:15px; }

    /* Pr√©visualisation PDF style */
    #cv-preview {
      width: 100%;
      border:1px solid #ccc;
      border-radius:8px;
      height: 100%;
    }

    /* Responsive */
    @media (max-width:900px) {
      .container { flex-direction: column; }
    }
  </style>
</head>
<body>

  <h2>Cr√©er votre CV Pro avec Pr√©visualisation</h2>

  <div class="container">
    <!-- Formulaire -->
    <div class="form-section">
      <h3>Infos personnelles</h3>
      <input type="text" id="prenom" placeholder="Pr√©nom">
      <input type="text" id="nom" placeholder="Nom">
      <input type="email" id="email" placeholder="Email">
      <input type="text" id="telephone" placeholder="T√©l√©phone">

      <h3>Titre & Profil</h3>
      <input type="text" id="titre" placeholder="Titre du poste">
      <textarea id="profil" placeholder="Pr√©sentation / Profil professionnel"></textarea>

      <h3>Comp√©tences</h3>
      <input type="text" id="competences" placeholder="Comp√©tences (s√©par√©es par virgule)">

      <h3>Exp√©riences professionnelles</h3>
      <div id="experiences"></div>
      <button type="button" onclick="addExperience()">+ Ajouter une exp√©rience</button>

      <h3>Formations</h3>
      <div id="formations"></div>
      <button type="button" onclick="addFormation()">+ Ajouter une formation</button>

      <h3>Langues</h3>
      <input type="text" id="langues" placeholder="Langues (s√©par√©es par virgule)">

      <h3>Photo de profil</h3>
      <input type="file" id="photo">

      <div style="text-align:center; margin-top:15px;">
        <button type="button" onclick="generatePDF()">üìÑ G√©n√©rer PDF</button>
        <button type="button" onclick="saveToFirestore()">üíæ Enregistrer</button>
      </div>
    </div>

    <!-- Pr√©visualisation -->
    <div class="preview-section">
      <h3>Pr√©visualisation du CV</h3>
      <iframe id="cv-preview"></iframe>
    </div>
  </div>

  <!-- JS dynamique pour exp√©riences / formations -->
  <script>
    function addExperience() {
      const div = document.createElement('div');
      div.classList.add('sub');
      div.innerHTML = `
        <input type="text" class="poste" placeholder="Poste">
        <input type="text" class="entreprise" placeholder="Entreprise">
        <input type="text" class="periode" placeholder="P√©riode">
        <textarea class="description" placeholder="Description"></textarea>
      `;
      document.getElementById('experiences').appendChild(div);
    }

    function addFormation() {
      const div = document.createElement('div');
      div.classList.add('sub');
      div.innerHTML = `
        <input type="text" class="diplome" placeholder="Dipl√¥me">
        <input type="text" class="etablissement" placeholder="√âtablissement">
        <input type="text" class="annee" placeholder="Ann√©e">
      `;
      document.getElementById('formations').appendChild(div);
    }
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
  // üî• Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDTEtE2wZdOH-er8RZvKrYSCfvQxaOdrbU",
    authDomain: "cv-generator-64183.firebaseapp.com",
    projectId: "cv-generator-64183",
    storageBucket: "cv-generator-64183.firebasestorage.app",
    messagingSenderId: "324040703397",
    appId: "1:324040703397:web:7e14624c1e52d16795fc4c"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // üîπ Convertir photo en base64
  function getPhotoBase64(fileInput) {
    return new Promise(resolve => {
      const file = fileInput.files[0];
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(file);
    });
  }

  // üîπ R√©cup√©rer les exp√©riences/formations
  function getExperiences() {
    return Array.from(document.querySelectorAll("#experiences .sub")).map(div => ({
      poste: div.querySelector(".poste").value,
      entreprise: div.querySelector(".entreprise").value,
      periode: div.querySelector(".periode").value,
      description: div.querySelector(".description").value
    }));
  }
  function getFormations() {
    return Array.from(document.querySelectorAll("#formations .sub")).map(div => ({
      diplome: div.querySelector(".diplome").value,
      etablissement: div.querySelector(".etablissement").value,
      annee: div.querySelector(".annee").value
    }));
  }

  // üîπ G√©n√©rer docDefinition PDF
  async function getDocDefinition() {
    const photo = await getPhotoBase64(document.getElementById("photo"));
    const experiences = getExperiences();
    const formations = getFormations();
    return {
      pageSize: 'A4',
      pageMargins: [40,40,40,40],
      content: [
        { text: document.getElementById("prenom").value + " " + document.getElementById("nom").value, style:'header' },
        { text: document.getElementById("titre").value, style:'subheader', margin:[0,0,0,10] },
        { text: "Profil", style:'sectionHeader' },
        { text: document.getElementById("profil").value, margin:[0,0,0,10] },
        { text: "Comp√©tences", style:'sectionHeader' },
        { ul: document.getElementById("competences").value.split(',').map(s=>s.trim()), margin:[0,0,0,10] },
        { text: "Exp√©riences", style:'sectionHeader' },
        ...experiences.map(exp=>({ stack:[
          { text: exp.poste+" - "+exp.entreprise+" ("+exp.periode+")", bold:true },
          { text: exp.description, margin:[0,0,0,5] }
        ]})),
        { text: "Formations", style:'sectionHeader', margin:[0,10,0,0] },
        ...formations.map(f=>({ text:`${f.diplome} - ${f.etablissement} (${f.annee})`, margin:[0,0,0,5] })),
        { text: "Langues", style:'sectionHeader', margin:[0,10,0,0] },
        { ul: document.getElementById("langues").value.split(',').map(s=>s.trim()) },
        photo ? { image: photo, width:100, alignment:'right', margin:[0,10,0,0] } : ''
      ],
      styles:{
        header:{ fontSize:20, bold:true, color:'#1e3c72' },
        subheader:{ fontSize:16, italics:true, color:'#2a5298' },
        sectionHeader:{ fontSize:14, bold:true, margin:[0,10,0,5], color:'#333' }
      }
    };
  }

  // üîπ Pr√©visualisation live
  async function updatePreview() {
    const docDef = await getDocDefinition();
    pdfMake.createPdf(docDef).getDataUrl((url)=>{
      document.getElementById("cv-preview").src = url;
    });
  }

  // üîπ Enregistrer Firestore
  async function saveToFirestore() {
    const experiences = getExperiences();
    const formations = getFormations();
    const cvData = {
      userID: "test_user",
      nom: document.getElementById("nom").value,
      prenom: document.getElementById("prenom").value,
      email: document.getElementById("email").value,
      telephone: document.getElementById("telephone").value,
      titre: document.getElementById("titre").value,
      profil: document.getElementById("profil").value,
      competences: document.getElementById("competences").value.split(',').map(s=>s.trim()),
      langues: document.getElementById("langues").value.split(',').map(s=>s.trim()),
      experiences,
      formations,
      dateCreation: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
      await db.collection("cvs").add(cvData);
      alert("‚úÖ CV enregistr√© dans Firestore !");
    } catch(err) {
      alert("‚ùå Erreur : "+err.message);
    }
  }

  // üîπ G√©n√©rer PDF et t√©l√©chargement
  async function generatePDF() {
    const docDef = await getDocDefinition();
    pdfMake.createPdf(docDef).download('CV_'+document.getElementById("prenom").value+'.pdf');
  }

  // üîπ √âv√©nements pour pr√©visualisation live
  const fields = ["prenom","nom","titre","profil","competences","langues","photo"];
  fields.forEach(id=>{
    document.getElementById(id).addEventListener('input', updatePreview);
  });

  // Observer les ajouts d'exp√©riences/formations
  const observerExp = new MutationObserver(updatePreview);
  observerExp.observe(document.getElementById("experiences"), {childList:true, subtree:true});
  const observerForm = new MutationObserver(updatePreview);
  observerForm.observe(document.getElementById("formations"), {childList:true, subtree:true});

  // Pr√©visualisation au chargement
  updatePreview();
</script>

</body>
  </html>
